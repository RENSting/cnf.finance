@model Cnf.Finance.Web.Models.MonthPerformViewModel

@{
    ViewData["Title"] = "月报";
}

<div class="card">
    <div class="card-header text-center">
        <a asp-action="Index" class="small float-left">返回</a>
        <h5>
            @(Model.Year)年 @(Model.Month) 月 两金指标完成月报
        </h5>
    </div>
    <div class="card-body">
        <div class="form-group row mb-0">
            <label asp-for="ProjectName" class="col-form-label col-form-label-sm col-2"></label>
            <div class="col-10">
                <input asp-for="ProjectName" class="form-control-plaintext form-control-sm" />
            </div>
        </div>
        <div class="form-group row">
            <label asp-for="ProjectIncoming" class="col-form-label col-form-label-sm col-2"></label>
            <div class="col-4">
                <input asp-for="ProjectIncoming" class="form-control-plaintext form-control-sm" />
            </div>
            <label asp-for="EstimatingProfit" class="col-form-label col-form-label-sm col-2"></label>
            <div class="col-4">
                <input asp-for="EstimatingProfit" class="form-control-plaintext form-control-sm" />
            </div>
        </div>
        <div class="card-group">
            <div class="card">
                <div class="card-body p-0">
                    <form method="post">
                        <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                        @Html.HiddenFor(m => m.ProjectId)
                        @Html.HiddenFor(m => m.Year)
                        @Html.HiddenFor(m => m.Month)
                        <table class="table table-sm table-bordered text-center small">
                            <thead class="thead-dark">
                                <tr>
                                    <th colspan="2">指标</th>
                                    <th>收入(万元)</th>
                                    <th>结算(万元)</th>
                                    <th>回款(万元)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="2">上年结转</td>
                                    <td>@Html.DisplayFor(m => m.IncomingBalance)</td>
                                    <td>@Html.DisplayFor(m => m.SettlementBalance)</td>
                                    <td>@Html.DisplayFor(m => m.RetrievableBalance)</td>
                                </tr>
                                <tr>
                                    <td rowspan="2" class="align-middle text-nowrap">当年累计<br />不含本月</td>
                                    <td class="text-nowrap">计划</td>
                                    <td>@Html.DisplayFor(m => m.TotalPlanIncoming)</td>
                                    <td>@Html.DisplayFor(m => m.TotalPlanSettlement)</td>
                                    <td>@Html.DisplayFor(m => m.TotalPlanRetrievable)</td>
                                </tr>
                                <tr>
                                    <td class="text-nowrap">实际</td>
                                    <td>@Html.DisplayFor(m => m.TotalIncoming)</td>
                                    <td>@Html.DisplayFor(m => m.TotalSettlement)</td>
                                    <td>@Html.DisplayFor(m => m.TotalRetrievalbe)</td>
                                </tr>
                                <tr>
                                    <td rowspan="2" class="align-middle text-nowrap">@(Model.Year)年<br />@(Model.Month)月</td>
                                    <td class="text-nowrap">计划</td>
                                    <td>@Html.DisplayFor(m => m.PlanIncoming)</td>
                                    <td>@Html.DisplayFor(m => m.PlanSettlement)</td>
                                    <td>@Html.DisplayFor(m => m.PlanRetrievalbe)</td>
                                </tr>
                                <tr>
                                    <td class="text-nowrap">实际</td>
                                    <td class="p-1">
                                        <input asp-for="Incoming" class="form-control form-control-sm" style="height:25px;"
                                               placeholder="请输入..." />
                                        <span asp-validation-for="Incoming" class="text-danger small"></span>
                                    </td>
                                    <td class="p-1">
                                        <input asp-for="Settlement" class="form-control form-control-sm" style="height:25px;"
                                               placeholder="请输入..." />
                                        <span asp-validation-for="Settlement" class="text-danger small"></span>
                                    </td>
                                    <td class="p-1">
                                        <input asp-for="Retrievable" class="form-control form-control-sm" style="height:25px;"
                                               placeholder="请输入..." />
                                        <span asp-validation-for="Retrievable" class="text-danger small"></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="2">
                                    </td>
                                    <td colspan="3" class="text-left">
                                        <div class="form-group">
                                            <button asp-action="Edit" class="btn btn-sm btn-primary">保存</button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </form>
                </div>
            </div>
            <div class="card">
                <div class="card-header bg-info text-white p-1 text-center">
                    依据及任务
                </div>
                <div class="card-body p-0">
                    <div class="d-flex border-bottom p-2">
                        <div class="mr-2 small text-info">
                            计<br />划
                        </div>
                        <div>
                            @if (Model.PlanTerms == null || Model.PlanTerms.Count() == 0)
                            {
                                <p class="text-muted">该月份没有计划任务</p>
                            }
                            else
                            {
                                <table class="table table-sm small table-bordered">
                                    <thead>
                                        <tr>
                                            <th>类型</th>
                                            <th>条款</th>
                                            <th>日期</th>
                                            <th>金额</th>
                                            <th>任务摘要</th>
                                            <th>执行</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var task in Model.PlanTerms)
                                        {
                                            <tr>
                                                <td>@Html.DisplayFor(m => task.TermsCategory)</td>
                                                <td>@Html.DisplayFor(m => task.Provision)</td>
                                                <td>@Html.DisplayFor(m => task.TargetDate)</td>
                                                <td>@Html.DisplayFor(m => task.TargetAmount)</td>
                                                <td>@Html.DisplayFor(m => task.Comments)</td>
                                                <td>
                                                    <a href="#" style="text-decoration:none; white-space:nowrap;"
                                                       onclick="performPlan();">Do&raquo;</a>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            }
                        </div>
                    </div>
                    <div class="d-flex border-top mt-2 p-2">
                        <div class="mr-2 small text-danger">
                            实<br />际
                        </div>
                        <div>
                            @if (Model.PerformTerms == null || Model.PerformTerms.Count() == 0)
                            {
                                <p class="text-muted">该月份没有已经执行的任务</p>
                            }
                            else
                            {
                                <table class="table table-sm small table-bordered">
                                    <thead>
                                        <tr>
                                            <th>类型</th>
                                            <th>条款</th>
                                            <th>日期</th>
                                            <th>金额</th>
                                            <th>完成情况摘要</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var task in Model.PerformTerms)
                                        {
                                            <tr>
                                                <td>@Html.DisplayFor(m => task.TermsCategory)</td>
                                                <td>@Html.DisplayFor(m => task.Provision)</td>
                                                <td>@Html.DisplayFor(m => task.TargetDate)</td>
                                                <td>@Html.DisplayFor(m => task.TargetAmount)</td>
                                                <td>@Html.DisplayFor(m => task.Comments)</td>
                                                <td>
                                                    <a href="#" style="text-decoration:none; white-space:nowrap;">修订</a>
                                                </td>
                                            </tr>
                                        }
                                        <tr>
                                            <td colspan="6">
                                                <button class="btn btn-sm btn-primary" type="button">添加完成情况条目</button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Model Edit Tasks -->
<form method="post">
    <div class="modal fade" id="dlgEditTask" data-backdrop="static" tabindex="-1" role="dialog"
         aria-labelledby="完成情况条目编辑" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editingTaskTitle">完成情况</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    @Html.HiddenFor(m => m.PerformId)
                    @Html.HiddenFor(m => m.EditingItemId, new { data_editing_itemid = "true" })
                    @Html.HiddenFor(m => m.SelectedTermsId, new { data_editing_selectedtermsid = "true" })
                    <div class="text-muted small">
                        请选择一条合同中对应的条款，输入当月完成情况的摘要说明后点击保存
                    </div>
                    <span id="selectedTermsIdValidator" class="text-danger small">必须从下表中选择一项合同条款作为依据</span>
                    <table class="table table-sm table-bordered table-hover small">
                        <thead class="thead-dark">
                            <tr>
                                <th></th>
                                <th>类型</th>
                                <th>触发日期</th>
                                <th>涉及金额(万)</th>
                                <th>合同条款</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var t in Model.Terms)
                            {
                                <tr title="@t.Remarks" onclick="clickTermsRow(this);">
                                    <td>
                                        <input type="radio" name="editingtermsid" onclick="clickTermsRadio(this);"
                                               data-editing-termsid="@t.TermsId" />
                                    </td>
                                    <td>@Html.DisplayFor(m => t.Category)</td>
                                    <td>@Html.DisplayFor(m => t.OnDate)</td>
                                    <td>@Html.DisplayFor(m => t.Amount)</td>
                                    <td>@Html.DisplayFor(m => t.Provision)</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                    <div class="form-group">
                        <label asp-for="EditingComments"></label>
                        <textarea asp-for="EditingComments" class="form-control form-control-sm"
                                  data-editing-task="true" rows="3" placeholder="请输入当月完成情况的摘要说明"></textarea>
                        <span asp-validation-for="EditingComments" class="text-danger small"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
                    <button asp-action="SavePerformItem" class="btn btn-primary"
                            onclick="if (checkSelectedTerms() == false) return false;">
                        保存条目
                    </button>
                    <button asp-action="DeletePerformItem" class="btn btn-danger" data-editing-delete="true"
                            onclick="if (confirm('删除条目不可恢复，确实要删除吗?') == false) return false;">
                        删除
                    </button>
                </div>
            </div>
        </div>
    </div>
</form>

@section Scripts{
    @{ await Html.RenderPartialAsync("_ValidationScriptsPartial");}

    <script type="text/javascript">
        function performPlan() {
            if (isPerformSaved() == false) {
                alert("必须首先输入指标完成值并点击保存按钮成功后才能录入工作条目");
                return false;
            }
            alert("saved");
            return false;
        }
        function isPerformSaved() {
            var result;
            @{ 
                if(Model.PerformId.HasValue && Model.PerformId > 0)
                {
                    @: result = true;
                }
                else
                {
                    @: result = false;
                }
            }
            return result;
        }
    </script>
}